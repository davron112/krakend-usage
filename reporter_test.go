package usage

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"net/http/httptest"
	"strings"
	"sync/atomic"
	"testing"
	"time"

	"github.com/catalinc/hashcash"
)

type mockUsageServer struct {
	newSession func(context.Context, *SessionRequest) (*SessionReply, error)
	sendReport func(context.Context, *ReportRequest) (*ReportReply, error)
}

func (t *mockUsageServer) NewSession(c context.Context, s *SessionRequest) (*SessionReply, error) {
	return t.newSession(c, s)
}

func (t *mockUsageServer) SendReport(c context.Context, r *ReportRequest) (*ReportReply, error) {
	return t.sendReport(c, r)
}

func TestReport(t *testing.T) {
	done := make(chan struct{}, 10)
	ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
	defer cancel()
	hasher := hashcash.New(hashBits, saltChars, defaultExtension)

	totReport := int32(5)
	var reports int32
	reportEndpoint := "/r"
	sessionEndpoint := "/s"

	s := httptest.NewServer(http.HandlerFunc(func(rw http.ResponseWriter, req *http.Request) {
		if req.URL.String() == sessionEndpoint {
			rw.Header().Set("Content-Type", "application/json")
			fmt.Fprintf(rw, `{"token":"some_token_value"}`)
			return
		}

		if req.URL.String() != reportEndpoint {
			t.Errorf("unknown endpoint %s", req.URL.String())
			http.Error(rw, "not found", 404)
			done <- struct{}{}
			return
		}

		tot := atomic.AddInt32(&reports, 1)

		if tot >= totReport+1 {
			done <- struct{}{}
			return
		}

		var msg ReportRequest
		if err := json.NewDecoder(req.Body).Decode(&msg); err != nil {
			t.Error(err)
		}
		req.Body.Close()

		if !hasher.Check(msg.Pow) {
			t.Errorf("wrong pow: %s", msg.Pow)
		}
		d, err := msg.Data.Hash()
		if err != nil {
			t.Error(err)
		}
		if !strings.Contains(msg.Pow, d) {
			t.Errorf("pow with unexpected hash. have: %s want: %s", msg.Pow, d)
		}
		if msg.Data.Expired() {
			t.Errorf("expired pow. have: %s", time.Unix(msg.Data.Time, 0))
		}

		if tot == 1 {
			if msg.Data.Extra == nil || len(msg.Data.Extra) == 0 {
				t.Error("nil extra")
				http.Error(rw, "crash", 500)
				return
			}

			if !bytes.Equal(msg.Data.Extra, expectedExtraPayload) {
				t.Errorf("unexpected extra payload. have %s", string(msg.Data.Extra))
				http.Error(rw, "crash", 500)
				return
			}
		} else {
			if msg.Data.Extra != nil && len(msg.Data.Extra) != 0 {
				t.Error("unexpected extra payload")
				http.Error(rw, "crash", 500)
				return
			}
		}

		rw.Header().Set("Content-Type", "application/json")
		fmt.Fprintf(rw, `{"status":200}`)
	}))

	defer s.Close()

	<-time.After(100 * time.Millisecond)

	if err := Report(
		ctx,
		Options{
			ClusterID:       "clusterId",
			ServerID:        "serverId",
			URL:             s.URL,
			ExtraPayload:    expectedExtraPayload,
			ReportLapse:     2 * time.Second,
			UserAgent:       "foo bar",
			ReportEndpoint:  reportEndpoint,
			SessionEndpoint: sessionEndpoint,
		},
		nil,
	); err != nil {
		t.Error(err)
		return
	}

	select {
	case <-ctx.Done():
	case <-done:
	}

	if reports != totReport+1 {
		t.Errorf("unexpected number of reports: %d", reports)
	}
}

var expectedExtraPayload = []byte{31, 139, 8, 0, 0, 0, 0, 0, 2, 255, 236, 221, 75, 111, 27, 85, 27, 7, 240, 115, 38, 238, 219, 246, 21, 136, 74, 44, 144, 16, 130, 138, 86, 168, 32, 181, 70, 108, 216, 161, 150, 203, 146, 21, 27, 164, 170, 66, 206, 100, 112, 166, 77, 60, 214, 120, 82, 193, 46, 20, 40, 229, 94, 248, 84, 124, 0, 190, 14, 25, 100, 199, 118, 72, 157, 214, 227, 40, 117, 155, 228, 39, 33, 181, 76, 231, 226, 251, 79, 255, 231, 60, 231, 204, 167, 245, 55, 43, 49, 158, 253, 44, 43, 239, 230, 105, 22, 235, 123, 33, 182, 226, 217, 143, 179, 170, 147, 111, 12, 98, 253, 93, 136, 255, 187, 209, 205, 122, 213, 32, 214, 191, 133, 120, 254, 147, 222, 90, 191, 200, 71, 255, 251, 103, 136, 255, 255, 168, 216, 236, 23, 189, 221, 127, 254, 41, 132, 240, 114, 253, 109, 18, 227, 153, 155, 183, 242, 94, 53, 58, 184, 21, 194, 107, 245, 175, 73, 140, 47, 222, 188, 213, 217, 90, 203, 171, 107, 163, 179, 141, 78, 86, 223, 15, 225, 131, 250, 251, 149, 24, 207, 140, 55, 222, 15, 113, 101, 255, 197, 207, 125, 216, 73, 239, 100, 189, 181, 65, 172, 127, 57, 224, 122, 175, 215, 63, 39, 49, 190, 52, 57, 247, 120, 231, 209, 190, 245, 131, 16, 222, 171, 127, 24, 62, 185, 233, 230, 7, 33, 38, 251, 207, 63, 115, 198, 87, 235, 31, 91, 49, 158, 159, 110, 30, 110, 141, 47, 12, 247, 13, 111, 212, 127, 36, 49, 94, 152, 92, 108, 242, 82, 140, 94, 137, 250, 97, 8, 55, 234, 223, 87, 98, 60, 183, 183, 253, 225, 162, 79, 231, 159, 149, 191, 63, 175, 239, 197, 24, 146, 157, 11, 219, 177, 213, 10, 97, 231, 149, 126, 140, 49, 214, 219, 49, 132, 225, 127, 143, 219, 54, 124, 98, 113, 39, 142, 54, 197, 157, 115, 187, 127, 94, 238, 230, 213, 250, 214, 234, 181, 180, 216, 108, 175, 101, 119, 139, 254, 224, 203, 78, 94, 173, 183, 239, 148, 157, 225, 131, 104, 247, 203, 226, 171, 175, 99, 18, 98, 43, 153, 158, 53, 153, 156, 244, 128, 77, 215, 167, 155, 174, 207, 110, 218, 123, 56, 245, 246, 236, 126, 123, 15, 123, 39, 89, 228, 193, 93, 220, 59, 54, 153, 92, 99, 242, 199, 34, 103, 72, 198, 103, 24, 190, 52, 241, 205, 39, 31, 120, 53, 205, 54, 38, 47, 99, 211, 125, 155, 237, 54, 243, 238, 37, 87, 231, 28, 119, 187, 24, 100, 237, 187, 157, 141, 124, 173, 83, 21, 101, 104, 124, 153, 214, 1, 31, 146, 131, 182, 37, 179, 219, 146, 208, 108, 219, 244, 93, 153, 124, 236, 234, 69, 63, 117, 71, 119, 138, 225, 231, 234, 226, 118, 211, 3, 91, 51, 207, 224, 242, 248, 139, 19, 15, 122, 122, 231, 47, 198, 228, 202, 156, 23, 126, 189, 170, 250, 105, 39, 93, 207, 194, 251, 243, 222, 162, 188, 76, 183, 242, 106, 181, 204, 58, 119, 178, 178, 221, 45, 198, 127, 27, 93, 127, 120, 169, 67, 159, 160, 249, 99, 156, 62, 197, 250, 175, 201, 151, 226, 63, 191, 27, 225, 209, 239, 92, 188, 52, 231, 101, 29, 158, 121, 252, 246, 53, 221, 247, 9, 191, 101, 251, 127, 40, 146, 134, 95, 243, 5, 191, 73, 207, 250, 82, 239, 52, 57, 199, 32, 239, 246, 178, 50, 44, 252, 83, 57, 249, 58, 188, 59, 231, 34, 27, 91, 157, 221, 131, 219, 171, 187, 46, 205, 252, 46, 28, 250, 52, 241, 74, 211, 131, 30, 121, 125, 198, 159, 197, 103, 115, 248, 248, 247, 231, 237, 121, 111, 206, 160, 232, 13, 210, 245, 108, 179, 51, 255, 99, 140, 233, 19, 192, 116, 147, 227, 14, 243, 171, 128, 233, 99, 203, 244, 82, 46, 117, 140, 152, 94, 240, 227, 127, 40, 211, 150, 127, 41, 76, 99, 26, 211, 152, 198, 52, 166, 79, 4, 211, 75, 140, 184, 152, 198, 52, 166, 49, 173, 232, 141, 105, 76, 99, 186, 241, 179, 90, 68, 115, 76, 99, 26, 211, 152, 62, 197, 76, 47, 101, 192, 216, 216, 244, 241, 176, 211, 216, 52, 166, 49, 173, 232, 173, 232, 45, 77, 75, 211, 90, 200, 48, 141, 105, 76, 75, 211, 152, 126, 254, 210, 52, 166, 141, 77, 99, 26, 211, 152, 150, 166, 49, 173, 232, 141, 105, 76, 99, 26, 211, 152, 198, 180, 162, 183, 162, 55, 166, 181, 144, 97, 26, 211, 152, 198, 180, 229, 77, 164, 105, 105, 26, 211, 152, 198, 52, 166, 49, 141, 105, 203, 155, 96, 26, 211, 152, 198, 52, 166, 49, 141, 105, 105, 26, 211, 152, 198, 52, 166, 49, 173, 133, 12, 211, 38, 100, 97, 26, 211, 152, 54, 33, 75, 154, 150, 166, 165, 105, 76, 99, 26, 211, 210, 180, 52, 45, 77, 27, 155, 182, 10, 25, 166, 49, 141, 105, 105, 26, 211, 152, 86, 244, 198, 52, 166, 49, 141, 105, 76, 43, 122, 99, 218, 188, 105, 243, 166, 49, 141, 105, 76, 99, 218, 98, 161, 210, 180, 52, 141, 105, 76, 99, 26, 211, 152, 86, 244, 198, 52, 166, 49, 141, 105, 45, 100, 152, 86, 244, 198, 180, 78, 111, 76, 99, 26, 211, 210, 180, 52, 45, 77, 99, 26, 211, 152, 198, 180, 52, 45, 77, 75, 211, 152, 86, 244, 198, 52, 166, 49, 45, 77, 99, 26, 211, 214, 244, 150, 166, 49, 141, 105, 76, 99, 90, 209, 91, 167, 183, 52, 141, 105, 76, 99, 26, 211, 152, 118, 191, 105, 76, 155, 55, 141, 105, 76, 99, 26, 211, 210, 180, 22, 50, 105, 90, 154, 198, 52, 166, 49, 141, 105, 105, 90, 154, 150, 166, 165, 105, 76, 99, 90, 167, 55, 166, 141, 77, 99, 90, 11, 25, 166, 49, 141, 105, 76, 99, 90, 209, 91, 167, 55, 166, 49, 141, 105, 69, 111, 76, 155, 144, 101, 108, 90, 154, 198, 52, 166, 49, 141, 105, 105, 90, 209, 91, 11, 217, 145, 92, 202, 216, 52, 166, 49, 173, 232, 141, 105, 105, 90, 209, 91, 11, 25, 166, 49, 141, 105, 76, 99, 26, 211, 138, 222, 138, 222, 152, 198, 52, 166, 49, 141, 105, 76, 155, 144, 133, 105, 76, 99, 218, 216, 180, 177, 105, 157, 222, 198, 166, 45, 111, 130, 105, 76, 75, 211, 210, 52, 166, 49, 173, 232, 141, 105, 76, 99, 26, 211, 152, 198, 52, 166, 49, 141, 105, 76, 99, 90, 209, 219, 216, 180, 177, 105, 76, 99, 26, 211, 152, 198, 52, 166, 49, 141, 105, 45, 100, 152, 198, 52, 166, 49, 173, 232, 173, 232, 173, 133, 76, 11, 25, 166, 49, 141, 105, 76, 75, 211, 152, 86, 244, 198, 52, 166, 49, 141, 105, 76, 187, 145, 229, 41, 93, 133, 76, 154, 198, 52, 166, 49, 141, 105, 69, 111, 69, 111, 105, 26, 211, 152, 198, 180, 9, 89, 152, 198, 52, 166, 181, 144, 97, 26, 211, 152, 150, 166, 21, 189, 141, 77, 99, 90, 154, 198, 52, 166, 49, 141, 105, 99, 211, 198, 166, 141, 77, 99, 26, 211, 152, 198, 52, 166, 21, 189, 221, 200, 82, 209, 27, 211, 152, 198, 52, 166, 165, 105, 69, 111, 69, 111, 105, 26, 211, 152, 198, 52, 166, 49, 141, 105, 203, 155, 96, 26, 211, 152, 198, 180, 162, 247, 17, 21, 189, 141, 77, 159, 6, 166, 21, 189, 49, 141, 105, 19, 178, 48, 173, 133, 12, 211, 38, 100, 97, 26, 211, 152, 150, 166, 165, 105, 105, 90, 167, 183, 52, 141, 105, 76, 99, 26, 211, 210, 52, 166, 117, 122, 99, 26, 211, 152, 86, 244, 198, 180, 22, 50, 69, 111, 157, 222, 152, 198, 52, 166, 165, 105, 69, 111, 243, 166, 49, 141, 105, 76, 99, 90, 154, 198, 180, 52, 109, 121, 19, 99, 211, 152, 198, 52, 166, 165, 105, 76, 99, 218, 216, 180, 52, 141, 105, 76, 75, 211, 210, 180, 22, 50, 19, 178, 76, 200, 146, 166, 49, 141, 105, 105, 26, 211, 210, 52, 166, 165, 105, 76, 99, 90, 154, 150, 166, 49, 141, 105, 76, 99, 26, 211, 152, 150, 166, 49, 141, 105, 76, 99, 26, 211, 152, 198, 52, 166, 49, 141, 105, 107, 122, 235, 244, 198, 52, 166, 49, 141, 105, 76, 99, 218, 29, 178, 164, 105, 76, 99, 26, 211, 152, 214, 233, 173, 232, 173, 211, 27, 211, 152, 198, 52, 166, 173, 66, 38, 77, 99, 26, 211, 152, 198, 52, 166, 49, 141, 105, 76, 107, 33, 195, 52, 166, 49, 141, 105, 69, 111, 99, 211, 152, 198, 52, 166, 49, 141, 105, 76, 99, 218, 98, 161, 199, 107, 77, 111, 76, 99, 26, 211, 150, 55, 193, 180, 162, 183, 52, 45, 77, 99, 26, 211, 152, 150, 166, 49, 125, 180, 76, 235, 244, 118, 135, 44, 45, 100, 152, 198, 52, 166, 49, 173, 232, 45, 77, 43, 122, 99, 26, 211, 152, 86, 244, 198, 52, 166, 49, 45, 77, 99, 26, 211, 210, 180, 52, 109, 121, 19, 203, 155, 72, 211, 152, 198, 52, 166, 49, 141, 105, 105, 90, 11, 153, 22, 50, 76, 99, 90, 209, 91, 209, 27, 211, 152, 94, 182, 157, 152, 198, 52, 166, 49, 45, 77, 235, 244, 54, 33, 75, 154, 54, 54, 141, 105, 76, 75, 211, 152, 54, 54, 109, 108, 90, 209, 27, 211, 152, 198, 52, 166, 49, 173, 232, 173, 133, 76, 167, 55, 166, 49, 173, 232, 173, 232, 109, 121, 19, 105, 90, 209, 27, 211, 152, 198, 52, 166, 49, 45, 77, 99, 90, 209, 27, 211, 152, 198, 180, 162, 183, 52, 173, 133, 76, 154, 150, 166, 49, 141, 105, 105, 26, 211, 210, 52, 166, 49, 141, 105, 76, 99, 26, 211, 152, 198, 180, 22, 50, 171, 144, 97, 26, 211, 152, 198, 52, 166, 45, 111, 98, 121, 19, 76, 99, 26, 211, 152, 198, 52, 166, 165, 105, 105, 26, 211, 152, 198, 52, 166, 49, 141, 105, 99, 211, 198, 166, 49, 141, 105, 76, 99, 26, 211, 152, 54, 33, 11, 211, 152, 198, 52, 166, 49, 141, 105, 76, 99, 26, 211, 152, 54, 111, 218, 188, 105, 76, 99, 26, 211, 152, 198, 52, 166, 49, 141, 105, 183, 222, 208, 233, 141, 105, 76, 99, 26, 211, 152, 198, 180, 52, 45, 77, 99, 26, 211, 152, 54, 54, 141, 105, 76, 99, 90, 167, 55, 166, 49, 141, 105, 76, 99, 26, 211, 199, 171, 232, 109, 222, 52, 166, 49, 141, 105, 76, 99, 26, 211, 210, 180, 52, 141, 105, 76, 27, 155, 198, 52, 166, 49, 141, 105, 76, 99, 26, 211, 210, 52, 166, 117, 122, 91, 44, 244, 169, 93, 10, 211, 152, 198, 52, 166, 49, 45, 77, 99, 218, 216, 52, 166, 49, 141, 105, 76, 99, 26, 211, 138, 222, 152, 198, 52, 166, 49, 141, 233, 167, 194, 244, 82, 236, 196, 180, 229, 77, 48, 141, 105, 76, 99, 26, 211, 198, 166, 165, 105, 69, 111, 76, 99, 26, 211, 58, 189, 49, 173, 232, 45, 77, 75, 211, 152, 198, 52, 166, 49, 141, 105, 99, 211, 38, 100, 233, 244, 198, 52, 166, 21, 189, 49, 141, 105, 105, 90, 154, 198, 52, 166, 49, 141, 233, 83, 222, 66, 102, 108, 90, 154, 150, 166, 49, 141, 105, 76, 99, 90, 167, 55, 166, 165, 105, 76, 99, 26, 211, 152, 86, 244, 86, 244, 198, 180, 52, 141, 105, 76, 99, 26, 211, 210, 180, 177, 233, 99, 52, 54, 141, 105, 76, 99, 26, 211, 152, 150, 166, 165, 105, 105, 26, 211, 152, 198, 180, 9, 89, 152, 198, 52, 166, 49, 141, 105, 76, 75, 211, 210, 52, 166, 49, 173, 133, 76, 11, 25, 166, 49, 45, 77, 99, 26, 211, 152, 198, 52, 166, 49, 141, 105, 105, 26, 211, 152, 182, 188, 9, 166, 49, 141, 105, 76, 99, 26, 211, 210, 244, 243, 118, 235, 13, 99, 211, 152, 198, 180, 162, 55, 166, 49, 45, 77, 155, 144, 133, 105, 76, 99, 90, 154, 54, 111, 218, 188, 105, 105, 218, 141, 44, 49, 141, 105, 76, 99, 90, 154, 198, 52, 166, 49, 141, 105, 76, 99, 26, 211, 152, 86, 244, 86, 244, 198, 52, 166, 49, 109, 108, 90, 209, 91, 209, 91, 154, 150, 166, 49, 141, 105, 105, 26, 211, 152, 198, 180, 121, 211, 152, 198, 52, 166, 49, 173, 232, 173, 232, 141, 105, 69, 111, 76, 99, 90, 209, 91, 209, 27, 211, 152, 150, 166, 165, 105, 76, 99, 90, 154, 198, 244, 51, 97, 122, 41, 151, 194, 180, 52, 141, 105, 76, 99, 26, 211, 152, 150, 166, 49, 45, 77, 99, 26, 211, 138, 222, 138, 222, 90, 200, 48, 109, 177, 80, 76, 99, 26, 211, 210, 180, 52, 45, 77, 75, 211, 138, 222, 152, 198, 52, 166, 49, 141, 105, 76, 187, 67, 150, 162, 55, 166, 49, 141, 105, 76, 43, 122, 75, 211, 152, 198, 52, 166, 49, 141, 105, 105, 90, 154, 198, 52, 166, 79, 36, 211, 103, 198, 215, 250, 226, 113, 123, 119, 139, 141, 162, 219, 205, 123, 221, 240, 214, 156, 61, 55, 179, 170, 204, 211, 65, 184, 52, 103, 191, 180, 40, 7, 251, 78, 182, 177, 85, 118, 250, 101, 113, 59, 75, 171, 209, 223, 219, 101, 177, 85, 13, 127, 28, 242, 222, 116, 224, 228, 177, 103, 91, 45, 170, 181, 172, 202, 210, 209, 215, 226, 223, 0, 0, 0, 255, 255, 59, 53, 67, 50, 233, 213, 3, 0}
